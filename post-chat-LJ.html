<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Virtual LJ</title>
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml">
    <link rel="alternate" type="application/atom+xml" title="Atom" href="/feed.xml">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!-- Sidebar is loaded dynamically -->
    <div id="sidebar"></div>

    <div id="content">
        <h1>Chat with Virtual Me!</h1>

        <p>TBH you are better of just using public media to reach out <a href="post-ljubomirj.html">online corrdinates</a> while I'm still living. This is ELIZA-level poor approximation. It has going for it that it was done with near zero effort, for the curiousity of 'can this ever work'??</p><br>

        <div id="messages">
            <!-- Optional: Add a message indicating loading -->
            <div class="ai-msg" id="loading-prompt-msg" style="font-style: italic;">Initializing Virtual LJ...</div>
        </div>

        <div class="chat-input">
            <!-- Start disabled until prompt loads -->
            <input type="text" id="user-input" placeholder="Loading prompt..." disabled>
            <button id="send-button" onclick="triggerSendMessage()" disabled>Send</button>
        </div>

        <script>
            // Global variable to store knowledge chunks
            let knowledgeBase = [];

            async function loadKnowledgeBase() {
                const knowledgeFilePath = 'knowledge.json';
                const loadingMsgElement = document.getElementById('loading-prompt-msg');
                const inputElement = document.getElementById('user-input');
                const sendButton = document.getElementById('send-button');

                try {
                    console.log(`Fetching knowledge base from: ${knowledgeFilePath}`);
                    const response = await fetch(knowledgeFilePath);

                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status} while fetching ${knowledgeFilePath}`);
                    }

                    const data = await response.json();
                    knowledgeBase = data.chunks;
                    console.log(`Successfully loaded ${knowledgeBase.length} knowledge chunks.`);

                    // Set a base system prompt
                    systemPrompt = `You are Ljubomir Josifovski (LJ), a computational researcher, living in the UK, originally from Macedonia. 
Respond using LJ's writing style and knowledge based *primarily* on the context provided in the user's message. 
Refer to this context first when answering questions about LJ's background, opinions, setup, and history. 
Maintain LJ's characteristic: concise answers with code examples when relevant, markdown formatting for code blocks.`;

                    if (loadingMsgElement) loadingMsgElement.remove();

                } catch (error) {
                    console.error('Error loading knowledge base:', error);
                    systemPrompt = "You are a helpful assistant. Error: Could not load knowledge base.";
                    if (loadingMsgElement) {
                        loadingMsgElement.textContent = "Error loading knowledge. Using fallback.";
                        loadingMsgElement.style.color = 'red';
                    }
                } finally {
                    if (inputElement) {
                        inputElement.disabled = false;
                        inputElement.placeholder = "Ask virtual-LJ anything...";
                    }
                    if (sendButton) sendButton.disabled = false;
                }
            }

            // --- Initialization ---
            document.addEventListener('DOMContentLoaded', (event) => {
                loadSidebar();
                loadKnowledgeBase();
            });

        </script>
    </div>

    <!-- Make sure scripts.js is loaded AFTER the inline script that needs systemPrompt -->
    <script src="scripts.js"></script>
    <!-- Remove the loadSidebar call from here if done within DOMContentLoaded -->
    <!-- <script>loadSidebar();</script> -->
</body>

</html>
