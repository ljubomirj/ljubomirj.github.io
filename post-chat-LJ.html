<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Virtual LJ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Sidebar is loaded dynamically -->
    <div id="sidebar"></div>

    <div id="content">
        <h1>Chat with Virtual Me!</h1>

        <div id="messages">
             <!-- Optional: Add a message indicating loading -->
             <div class="ai-msg" id="loading-prompt-msg" style="font-style: italic;">Initializing Virtual LJ...</div>
        </div>

        <div class="chat-input">
             <!-- Start disabled until prompt loads -->
            <input type="text" id="user-input" placeholder="Loading prompt..." disabled>
            <button id="send-button" onclick="triggerSendMessage()" disabled>Send</button>
        </div>

        <script>
            // Declare systemPrompt globally so it's accessible later
            let systemPrompt = "You are a helpful assistant."; // Default fallback

            async function loadSystemPrompt() {
                const promptFilePath = 'chat-LJ-prompt.txt'; // Assuming it's in the same directory
                const initialInstruction = `You are Ljubomir Josifovski (LJ), a computational researcher, living in the UK, originally from Macedonia. Respond using LJ's writing style and knowledge based *primarily* on the extensive context provided below between the '--- START ...' and '--- END ...' markers. Refer to this context first when answering questions about LJ's background, opinions, setup, and history. Maintain LJ's characteristic: concise answers with code examples when relevant, markdown formatting for code blocks.`;
                const loadingMsgElement = document.getElementById('loading-prompt-msg');
                const inputElement = document.getElementById('user-input');
                const sendButton = document.getElementById('send-button');


                try {
                    console.log(`Fetching system prompt from: ${promptFilePath}`);
                    const response = await fetch(promptFilePath);

                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status} while fetching ${promptFilePath}`);
                    }

                    const promptTextFromFile = await response.text();
                    console.log("Successfully fetched prompt text.");

                    // Construct the final prompt
                    systemPrompt = initialInstruction
                                 + "\n\n--- START OF LJ CONTEXT ---\n"
                                 + promptTextFromFile
                                 + "\n--- END OF LJ CONTEXT ---";

                    console.log("System prompt loaded successfully.");
                    if (loadingMsgElement) loadingMsgElement.remove(); // Remove loading message

                } catch (error) {
                    console.error('Error loading system prompt:', error);
                    // Keep the default fallback prompt
                    systemPrompt = "You are a helpful assistant. Error: Could not load detailed persona.";
                     if (loadingMsgElement) {
                        loadingMsgElement.textContent = "Error loading detailed prompt. Using fallback.";
                        loadingMsgElement.style.color = 'red';
                     }
                     // Still allow chatting with the fallback prompt
                } finally {
                     // Enable input and button regardless of success or failure
                     if(inputElement) {
                        inputElement.disabled = false;
                        inputElement.placeholder = "Ask virtual-LJ anything...";
                     }
                     if(sendButton) sendButton.disabled = false;
                }
            }

            // --- Initialization ---
            // Call loadSidebar and loadSystemPrompt when the page structure is ready
            document.addEventListener('DOMContentLoaded', (event) => {
                 loadSidebar(); // Assuming loadSidebar is defined in scripts.js
                 loadSystemPrompt(); // Load the custom system prompt
            });

        </script>
    </div>

    <!-- Make sure scripts.js is loaded AFTER the inline script that needs systemPrompt -->
    <script src="scripts.js"></script>
    <!-- Remove the loadSidebar call from here if done within DOMContentLoaded -->
    <!-- <script>loadSidebar();</script> -->
</body>
</html>
